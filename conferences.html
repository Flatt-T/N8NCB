<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>conferenceBuddy ¬∑ Conferences</title>
  <meta name="description" content="Create, view, and report on conferences using n8n Flow Endpoints" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0b0d12;
      --card: #121623;
      --muted: #8a93a6;
      --text: #e7ecf7;
      --primary: #7c5cff; /* accent */
      --primary-600:#6847ff;
      --danger: #ef476f;
      --ok: #4cc9f0;
      --ring: #2a2f3d;
      --border: #1c2130;
      --shadow: 0 8px 24px rgba(0,0,0,.35);
      --radius: 16px;
    }
    * { box-sizing: border-box }
    html, body { height: 100% }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 100% -20%, rgba(124,92,255,0.18), transparent),
                  radial-gradient(1000px 600px at -10% 0%, rgba(76,201,240,0.12), transparent),
                  var(--bg);
      color: var(--text);
    }
    a { color: var(--ok); text-decoration: none }
    header {
      position: sticky; top: 0; z-index: 5;
      backdrop-filter: saturate(1.2) blur(6px);
      background: linear-gradient(to bottom, rgba(11,13,18,0.9), rgba(11,13,18,0.6));
      border-bottom: 1px solid var(--border);
    }
    .nav {
      display: flex; align-items: center; justify-content: space-between;
      gap: 12px; padding: 14px 16px; max-width: 1200px; margin: 0 auto;
    }
    .brand { display: flex; align-items: center; gap: 10px; font-weight: 700; letter-spacing: .3px }
    .brand .logo { width: 28px; height: 28px; border-radius: 8px; background: linear-gradient(135deg, var(--primary), var(--ok)); box-shadow: var(--shadow) }
    .nav-actions { display: flex; align-items: center; gap: 8px }
    .btn, button { appearance: none; border: 1px solid var(--ring); background: #0f1320; color: var(--text); padding: 10px 14px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: .2s ease; }
    .btn:hover { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(124,92,255,.12) }
    .btn.primary { background: linear-gradient(180deg, var(--primary), var(--primary-600)); border: none }
    .btn.ghost { background: transparent }
    .icon { width: 20px; height: 20px; display: inline-grid; place-items: center }

    main { max-width: 1200px; margin: 16px auto; padding: 0 16px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 16px }
    @media (min-width: 980px) {
      .grid { grid-template-columns: 360px 1fr }
    }
    .card { background: linear-gradient(180deg, rgba(18,22,35,.98), rgba(18,22,35,.9)); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow) }
    .card h3 { margin: 0 0 8px; font-size: 18px }
    .card .p { color: var(--muted); font-size: 14px }
    .section { padding: 16px }
    .divider { height: 1px; background: var(--border); margin: 12px 0 }

    .field { display: grid; gap: 6px; margin-bottom: 12px }
    label { font-size: 13px; color: var(--muted) }
    input, textarea, select { width: 100%; background: #0b0f1a; color: var(--text); border: 1px solid var(--ring); border-radius: 12px; padding: 10px 12px; outline: none; transition: .2s; }
    input:focus, textarea:focus, select:focus{ border-color: var(--primary); box-shadow: 0 0 0 4px rgba(124,92,255,.12) }
    textarea { min-height: 72px; resize: vertical }

    .list { display: flex; flex-direction: column; gap: 8px; }
    .item { border: 1px solid var(--ring); background: #0c101b; border-radius: 12px; padding: 10px; display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 8px; cursor: pointer }
    .item:hover { border-color: var(--primary) }
    .item .title { font-weight: 600 }
    .item .meta { font-size: 12px; color: var(--muted) }
    .item .badge { background: #141a2a; border: 1px solid var(--ring); padding: 2px 8px; border-radius: 999px; font-size: 12px; color: var(--muted) }

    .toolbar { display: flex; gap: 8px; align-items: center; flex-wrap: wrap }
    .toolbar .grow { flex: 1 }

    .stack { display: grid; gap: 12px }
    .two { display: grid; gap: 12px; grid-template-columns: 1fr; }
    @media (min-width: 720px) { .two { grid-template-columns: 1fr 1fr } }

    .detail { display: grid; gap: 12px }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap }

    .tag { display: inline-block; padding: 4px 8px; border: 1px solid var(--ring); border-radius: 999px; font-size: 12px; color: var(--muted) }

    .pill { display: inline-flex; align-items: center; gap: 8px; padding: 8px 10px; border: 1px solid var(--ring); border-radius: 12px; color: var(--muted) }

    .empty { text-align: center; color: var(--muted); padding: 24px }

    .skeleton { position: relative; overflow: hidden; background: #111524; border: 1px solid var(--ring); border-radius: 12px; height: 56px }
    .skeleton::after { content: ""; position: absolute; inset: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,.06), transparent); transform: translateX(-100%); animation: shine 1.2s infinite }
    @keyframes shine { 100% { transform: translateX(100%) } }

    /* Tabs */
    .tabs { display: flex; gap: 6px; flex-wrap: wrap }
    .tab { border: 1px solid var(--ring); padding: 8px 12px; border-radius: 10px; cursor: pointer; color: var(--muted) }
    .tab.active { color: var(--text); border-color: var(--primary) }

    /* Toasts */
    #toasts { position: fixed; right: 16px; bottom: 16px; display: grid; gap: 10px; z-index: 50 }
    .toast { background: #0c101b; border: 1px solid var(--ring); border-left: 4px solid var(--primary); border-radius: 12px; padding: 12px 14px; box-shadow: var(--shadow) }

    /* Debug Drawer */
    .debug-toggle { position: fixed; right: 16px; bottom: 16px; z-index: 85 }
    .debug-drawer { position: fixed; left: 12px; right: 12px; bottom: 12px; z-index: 90; display: none; }
    .debug-drawer[open] { display: block }
    .debug-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; box-shadow: var(--shadow); padding: 10px }
    .debug-head { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 8px }
    .debug-actions { display: flex; gap: 8px; flex-wrap: wrap }
    .debug-body { background: #0b0f1a; border: 1px solid var(--ring); border-radius: 10px; padding: 8px; max-height: 32vh; overflow: auto; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 12px; line-height: 1.45 }
    .logline { display: grid; grid-template-columns: 120px 80px 1fr; gap: 8px; padding: 4px 6px; border-bottom: 1px dashed #1c2130 }
    .logline:last-child { border-bottom: 0 }
    .lvl-info { color: #8a93a6 }
    .lvl-success { color: #75f0a6 }
    .lvl-error { color: #ff7b9c }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace }

    .download-link { display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; border: 1px dashed var(--ring); border-radius: 10px }
    .muted { color: var(--muted) }
    .right { margin-left: auto }
  </style>
</head>
<body>
<header>
  <div class="nav">
    <div class="brand"><span class="logo"></span> conferenceBuddy</div>
    <div class="nav-actions">
      <button class="btn ghost" id="refreshBtn" title="Refresh data">‚ü≥</button>
      <a class="btn" href="index.html" title="Back to Home">Home</a>
      <a class="btn primary" href="#create" title="Create Conference">+ New</a>
    </div>
  </div>
</header>

<main class="grid">
  <!-- Left rail: Create + List -->
  <section class="card" id="create">
    <div class="section">
      <h3>Create conference</h3>
      <p class="p">Fill in the details and save. Data is sent to your n8n Flow Endpoint (<code>createConference</code>). Settings are now on the <a href="index.html">homepage</a>.</p>
      <form id="createForm" class="stack" autocomplete="off">
        <div class="field"><label for="cName">Name</label><input id="cName" name="name" placeholder="e.g., DevSummit Europe 2026" required /></div>
        <div class="two">
          <div class="field"><label for="cStart">Start date</label><input id="cStart" name="startDate" type="date" required /></div>
          <div class="field"><label for="cEnd">End date</label><input id="cEnd" name="endDate" type="date" required /></div>
        </div>
        <div class="two">
          <div class="field"><label for="cLocation">Location</label><input id="cLocation" name="location" placeholder="City, Country" /></div>
          <div class="field"><label for="cTimezone">Timezone</label><input id="cTimezone" name="timezone" placeholder="Europe/London" /></div>
        </div>
        <div class="field"><label for="cDesc">Description</label><textarea id="cDesc" name="description" placeholder="Short description"></textarea></div>
        <div class="field"><label for="cAims">Aims of the conference</label><textarea id="cAims" name="aims" placeholder="What are the goals/desired outcomes?"></textarea></div>
        <div class="field"><label for="cTags">Tags (comma-separated)</label><input id="cTags" name="tags" placeholder="Cloud, AI, Security" /></div>
        <div class="row">
          <button class="btn primary" type="submit">Create</button>
          <button class="btn" type="reset">Reset</button>
          <span id="createHint" class="muted">Saved items appear in the list.</span>
        </div>
      </form>
    </div>
    <div class="divider"></div>
    <div class="section">
      <div class="toolbar">
        <h3 style="margin:0">Conferences</h3>
        <input class="grow" id="search" placeholder="Search by name, location‚Ä¶" />
      </div>
      <div class="list" id="confList" aria-live="polite">
        <div class="skeleton"></div>
        <div class="skeleton"></div>
        <div class="skeleton"></div>
      </div>
    </div>
  </section>

  <!-- Right: Details -->
  <section class="card" id="details">
    <div class="section">
      <div class="row">
        <h3 style="margin:0">Details</h3>
        <div class="right pill" id="selectedMeta">No conference selected</div>
      </div>
      <div id="emptyState" class="empty">Select a conference from the list to view enriched data, sessions, vendors, and reports.</div>
      <div id="detailWrap" class="detail" style="display:none">
        <div>
          <div class="row" style="justify-content: space-between">
            <div id="confTitle" class="title" style="font-size:20px; font-weight:700"></div>
            <div class="row">
              <button id="eodBtn" class="btn">End-of-Day Report</button>
              <button id="eocBtn" class="btn">End-of-Conference Report</button>
            </div>
          </div>
          <div class="p" id="confMeta"></div>
          <div class="p" id="confDesc" style="margin-top:6px"></div>
        </div>
        <div class="tabs" role="tablist">
          <button class="tab active" data-tab="overview" role="tab" aria-selected="true">Overview</button>
          <button class="tab" data-tab="vendors" role="tab">Vendors</button>
          <button class="tab" data-tab="sessions" role="tab">Sessions</button>
          <button class="tab" data-tab="reports" role="tab">Reports</button>
        </div>
        <div id="tab-overview" class="stack" role="tabpanel">
          <div class="two">
            <div class="card section">
              <div class="row" style="justify-content: space-between"><strong>Key metrics</strong><span class="muted" id="ovrUpdated"></span></div>
              <div class="two" style="margin-top:8px">
                <div class="pill"><span>üßë‚Äçü§ù‚Äçüßë</span><div><div>Total attendees</div><strong id="mAttendees">‚Äì</strong></div></div>
                <div class="pill"><span>‚≠ê</span><div><div>Avg session rating</div><strong id="mAvgRating">‚Äì</strong></div></div>
                <div class="pill"><span>üè™</span><div><div>Vendors</div><strong id="mVendors">‚Äì</strong></div></div>
                <div class="pill"><span>üóìÔ∏è</span><div><div>Sessions</div><strong id="mSessions">‚Äì</strong></div></div>
              </div>
            </div>
            <div class="card section">
              <strong>Sessions by day</strong>
              <canvas id="chartSessionsByDay" height="160"></canvas>
            </div>
          </div>
        </div>
        <div id="tab-vendors" class="stack" role="tabpanel" hidden>
          <div class="row" style="justify-content: space-between"><strong>Vendors</strong>
            <div class="row">
              <button id="vendorReportSelected" class="btn">Report (selected)</button>
            </div>
          </div>
          <div class="list" id="vendorList"></div>
        </div>
        <div id="tab-sessions" class="stack" role="tabpanel" hidden>
          <div class="row" style="justify-content: space-between"><strong>Sessions</strong>
            <div class="row">
              <button id="sessionReportSelected" class="btn">Report (selected)</button>
            </div>
          </div>
          <div class="list" id="sessionList"></div>
        </div>
        <div id="tab-reports" class="stack" role="tabpanel" hidden>
          <div class="row" style="justify-content: space-between"><strong>Generate reports</strong><span class="muted">Outputs download automatically when ready</span></div>
          <div class="two">
            <div class="card section">
              <div class="row" style="justify-content: space-between"><strong>End of Day</strong>
                <input type="date" id="eodDate" />
              </div>
              <button id="eodBtn2" class="btn">Generate EOD</button>
            </div>
            <div class="card section">
              <strong>End of Conference</strong>
              <button id="eocBtn2" class="btn">Generate EOC</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<div id="toasts"></div>

<!-- Debug Drawer -->
<button class="btn debug-toggle" id="debugToggle">üêû Debug</button>
<div class="debug-drawer" id="debugDrawer">
  <div class="debug-card">
    <div class="debug-head">
      <strong>Debug log</strong>
      <div class="debug-actions">
        <button class="btn" id="dbgPause">Pause</button>
        <button class="btn" id="dbgCopy">Copy</button>
        <button class="btn" id="dbgClear">Clear</button>
        <button class="btn" id="dbgClose">Close</button>
      </div>
    </div>
    <div id="debugBody" class="debug-body" aria-live="polite"></div>
  </div>
</div>

<script>
/**
 * conferenceBuddy ‚Äî Conferences SPA (with Debug Drawer)
 *
 * This front-end talks to n8n Flow Endpoints for all data/functions.
 * IMPORTANT: Config (base URL, auth, flow paths) now lives in localStorage and is edited on the homepage (index.html).
 */

const DEFAULT_CONFIG = {
  baseUrl: "",
  useGet: false,
  authHeader: "",
  authValue: "",
  flows: {
    listConferences: "/conferences/list",
    getConference: "/conferences/get",
    createConference: "/conferences/create",      // expects { name, startDate, endDate, location, timezone, description, aims, tags }
    vendorsByConference: "/vendors/by-conference",
    sessionsByConference: "/sessions/by-conference",
    vendorStats: "/vendors/stats",
    sessionStats: "/sessions/stats",
    reportEOD: "/reports/eod",
    reportEOC: "/reports/eoc",
    reportVendor: "/reports/vendor",
    reportSession: "/reports/session"
  }
};

let CONFIG = loadConfig();
function loadConfig(){
  try { return { ...DEFAULT_CONFIG, ...(JSON.parse(localStorage.getItem("cb.cfg")||"{}")) } } catch { return DEFAULT_CONFIG }
}
function saveConfig(){ localStorage.setItem("cb.cfg", JSON.stringify(CONFIG)); }

// --- Utilities ---
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
function toast(msg, type="info"){ const node = document.createElement('div'); node.className='toast'; node.innerHTML = msg; $('#toasts').appendChild(node); setTimeout(()=> node.remove(), 4000); }
function fmtDate(d){ if(!d) return "‚Äî"; const dt = (d instanceof Date) ? d : new Date(d); return dt.toLocaleDateString(undefined, { year:'numeric', month:'short', day:'2-digit' }); }
function fmtNum(n){ if(n===undefined||n===null) return "‚Äî"; return new Intl.NumberFormat().format(n) }
function byId(id){ return (x)=> x.id===id }

// --- Debug logger ---
const Debug = {
  paused: false,
  add(level, message, data){
    const ts = new Date();
    const body = $('#debugBody');
    const line = document.createElement('div');
    line.className = `logline lvl-${level}`;
    const tsStr = ts.toLocaleTimeString([], {hour12:false});
    const dataStr = data ? escapeHtml(JSON.stringify(sanitize(data))) : '';
    line.innerHTML = `<span class="mono">${tsStr}</span><span class="mono">${level.toUpperCase()}</span><span>${escapeHtml(message)}${data?` ‚Äî <span class=\"mono\">${dataStr}</span>`:''}</span>`;
    body.appendChild(line);
    if(!Debug.paused){ body.scrollTop = body.scrollHeight }
  }
};
function logInfo(msg, data){ Debug.add('info', msg, data) }
function logSuccess(msg, data){ Debug.add('success', msg, data) }
function logError(msg, data){ Debug.add('error', msg, data) }
function escapeHtml(s){ return s?.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) }
function sanitize(obj){ try { const clone = JSON.parse(JSON.stringify(obj||{})); if(clone.authValue) clone.authValue = '***'; return clone } catch { return obj } }

// Debug UI controls
$('#debugToggle').addEventListener('click', ()=> { $('#debugDrawer').toggleAttribute('open'); });
$('#dbgClose').addEventListener('click', ()=> { $('#debugDrawer').removeAttribute('open'); });
$('#dbgClear').addEventListener('click', ()=> { $('#debugBody').innerHTML = ''; });
$('#dbgCopy').addEventListener('click', async ()=>{
  let text = Array.from($('#debugBody').querySelectorAll('.logline')).map(n=> n.textContent).join('\n');
  try { await navigator.clipboard.writeText(text); toast('Copied debug log'); } catch { toast('Copy failed') }
});
$('#dbgPause').addEventListener('click', (e)=>{ Debug.paused = !Debug.paused; e.target.textContent = Debug.paused? 'Resume' : 'Pause'; });

// n8n fetch wrapper
async function callFlow(key, payload={}){
  const base = CONFIG.baseUrl?.trim();
  const path = CONFIG.flows[key];
  if(!base || !path){ const err = `Missing baseUrl or flow path for ${key}`; logError(err); throw new Error(err) }
  const url = base + path;
  const headers = { 'Content-Type': 'application/json' };
  if(CONFIG.authHeader && CONFIG.authValue){ headers[CONFIG.authHeader] = CONFIG.authValue }
  const init = CONFIG.useGet
    ? { method: 'GET', headers }
    : { method: 'POST', headers, body: JSON.stringify(payload) };

  const finalUrl = CONFIG.useGet && payload && Object.keys(payload).length
    ? url + '?' + new URLSearchParams(payload).toString()
    : url;

  const started = performance.now();
  logInfo(`‚Üí ${key} ${init.method} ${path}`, { payload: payload });
  const res = await fetch(finalUrl, init).catch(e=>{ throw new Error('Network error: '+e.message) });
  const ms = Math.round(performance.now()-started);
  if(!res.ok){
    let text = await res.text().catch(()=>"(no body)");
    logError(`‚úñ ${key} ${res.status} ${res.statusText} (${ms}ms)`, { body: text.slice(0,400) });
    throw new Error(`Flow ${key} failed: ${res.status} ${res.statusText} ‚Äî ${text}`)
  }
  const contentType = res.headers.get('content-type')||'';
  logSuccess(`‚úì ${key} ${res.status} (${ms}ms)`, { contentType });
  if(contentType.includes('application/json')) return res.json();
  const blob = await res.blob();
  return { __blob: blob, __filename: filenameFromDisposition(res.headers.get('content-disposition')) };
}

function filenameFromDisposition(dispo){
  if(!dispo) return undefined;
  const m = /filename\*=UTF-8''([^;]+)|filename="?([^\";]+)"?/i.exec(dispo);
  return decodeURIComponent(m?.[1]||m?.[2]||'download');
}

function triggerDownloadFromBlob(blob, filename='download'){
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob); link.download = filename; document.body.appendChild(link); link.click(); link.remove(); setTimeout(()=> URL.revokeObjectURL(link.href), 5000);
}

// --- State ---
let state = {
  conferences: [],
  selectedId: null,
  charts: { sessionsByDay: null },
  selectedVendorIds: new Set(),
  selectedSessionIds: new Set()
};

// --- UI Binding ---
$('#refreshBtn').addEventListener('click', ()=>{ logInfo('Refresh requested'); refreshAll(); });

$('#createForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const data = Object.fromEntries(new FormData(e.target).entries());
  if(data.tags) data.tags = data.tags.split(',').map(s=>s.trim()).filter(Boolean);
  try {
    const out = await callFlow('createConference', data);
    toast('Conference created');
    logSuccess('Conference created', out);
    e.target.reset();
    await loadConferences();
    if(out?.id){ selectConference(out.id) }
  } catch(err){ logError('Create failed', { message: err.message }); toast(`<strong>Error:</strong> ${err.message}`) }
});

$('#search').addEventListener('input', renderConferenceList);

// Tab handling
$$('.tab').forEach(btn=> btn.addEventListener('click', ()=>{
  $$('.tab').forEach(b=> b.classList.remove('active'));
  btn.classList.add('active');
  const name = btn.dataset.tab;
  $$('#detailWrap [role="tabpanel"]').forEach(p=> p.hidden = true);
  $(`#tab-${name}`).hidden = false;
  logInfo('Tab switched', { tab: name });
}));

$('#eodBtn').addEventListener('click', ()=> generateEOD());
$('#eocBtn').addEventListener('click', ()=> generateEOC());
$('#eodBtn2').addEventListener('click', ()=> generateEOD());
$('#eocBtn2').addEventListener('click', ()=> generateEOC());
$('#vendorReportSelected').addEventListener('click', ()=> generateVendorReport());
$('#sessionReportSelected').addEventListener('click', ()=> generateSessionReport());

// --- Data loaders ---
async function loadConferences(){
  const list = $('#confList');
  list.innerHTML = '<div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>';
  try {
    const res = await callFlow('listConferences', {});
    state.conferences = Array.isArray(res?.items) ? res.items : (Array.isArray(res)?res:[]);
  } catch(err){ toast(`<strong>Load failed:</strong> ${err.message}`); logError('List failed', { message: err.message }); state.conferences = [] }
  renderConferenceList();
}

function renderConferenceList(){
  const q = ($('#search').value||'').toLowerCase();
  const list = $('#confList');
  const items = (state.conferences||[]) 
    .filter(c=> !q || [c.name, c.location, c.description].filter(Boolean).join(' ').toLowerCase().includes(q))
    .sort((a,b)=> new Date(b.startDate||0) - new Date(a.startDate||0));
  if(!items.length){ list.innerHTML = `<div class="empty">No conferences found</div>`; return }
  list.innerHTML = '';
  for(const c of items){
    const node = document.createElement('div'); node.className='item'; node.tabIndex=0; node.role='button';
    const dateStr = [fmtDate(c.startDate), fmtDate(c.endDate)].filter(Boolean).join(' ‚Äì ');
    node.innerHTML = `<div><div class="title">${c.name||'Untitled'}</div>
      <div class="meta">${dateStr}${c.location?` ¬∑ ${c.location}`:''}</div></div>
      <div class="badge">${(c.tags||[]).slice(0,3).join(', ')}</div>`;
    node.addEventListener('click', ()=> selectConference(c.id||c.conferenceId||c._id));
    list.appendChild(node);
  }
}

async function selectConference(id){
  state.selectedId = id;
  logInfo('Select conference', { id });
  $('#emptyState').style.display = 'none';
  $('#detailWrap').style.display = '';
  $('#selectedMeta').textContent = 'Loading‚Ä¶';
  $('#vendorList').innerHTML = '<div class="skeleton"></div><div class="skeleton"></div>';
  $('#sessionList').innerHTML = '<div class="skeleton"></div><div class="skeleton"></div>';

  try {
    const [conf, vendors, sessions, vStats, sStats] = await Promise.all([
      callFlow('getConference', { conferenceId: id }),
      callFlow('vendorsByConference', { conferenceId: id }),
      callFlow('sessionsByConference', { conferenceId: id }),
      callFlow('vendorStats', { conferenceId: id }),
      callFlow('sessionStats', { conferenceId: id })
    ]);
    renderDetails(conf, vendors, sessions, vStats, sStats);
    logSuccess('Details loaded');
  } catch(err){ logError('Detail load failed', { message: err.message }); toast(`<strong>Load failed:</strong> ${err.message}`) }
}

function renderDetails(conf, vendors, sessions, vStats, sStats){
  const c = conf?.item || conf || {};
  const vs = Array.isArray(vendors?.items)?vendors.items:(vendors||[]);
  const ss = Array.isArray(sessions?.items)?sessions.items:(sessions||[]);

  $('#confTitle').textContent = c.name || 'Untitled';
  $('#confMeta').textContent = `${fmtDate(c.startDate)} ‚Äì ${fmtDate(c.endDate)}${c.location?` ¬∑ ${c.location}`:''}${c.timezone?` ¬∑ ${c.timezone}`:''}`;
  $('#confDesc').textContent = c.description || '';
  $('#selectedMeta').textContent = c.id || c.conferenceId || '';

  // Metrics
  const totalAttendees = sStats?.totals?.attendees ?? c.attendees ?? null;
  const avgRating = (sStats?.totals?.avgRating ?? c.avgRating ?? null);
  $('#mAttendees').textContent = fmtNum(totalAttendees);
  $('#mAvgRating').textContent = avgRating? Number(avgRating).toFixed(2) : '‚Äî';
  $('#mVendors').textContent = fmtNum(vs.length);
  $('#mSessions').textContent = fmtNum(ss.length);
  $('#ovrUpdated').textContent = c.updatedAt ? `Updated ${fmtDate(c.updatedAt)}` : '';

  // Vendors
  state.selectedVendorIds.clear();
  const vList = $('#vendorList'); vList.innerHTML = '';
  if(!vs.length) vList.innerHTML = '<div class="empty">No vendors</div>';
  for(const v of vs){
    const leads = (vStats?.byVendor?.[v.id||v.vendorId]?.leads) ?? v.leads;
    const sessionsHosted = (vStats?.byVendor?.[v.id||v.vendorId]?.sessions) ?? v.sessionsHosted;
    const node = document.createElement('div'); node.className='item';
    node.innerHTML = `<div><div class="title">${v.name||'Vendor'}</div>
      <div class="meta">Leads: ${fmtNum(leads)} ¬∑ Sessions: ${fmtNum(sessionsHosted)}${v.booth?` ¬∑ Booth ${v.booth}`:''}</div></div>
      <label class="badge"><input type="checkbox" data-vid="${v.id||v.vendorId}" /> Select</label>`;
    node.querySelector('input').addEventListener('change', (e)=>{
      const id = e.target.dataset.vid; if(e.target.checked) state.selectedVendorIds.add(id); else state.selectedVendorIds.delete(id);
    });
    vList.appendChild(node);
  }

  // Sessions
  state.selectedSessionIds.clear();
  const sList = $('#sessionList'); sList.innerHTML = '';
  if(!ss.length) sList.innerHTML = '<div class="empty">No sessions</div>';
  for(const s of ss){
    const stats = sStats?.bySession?.[s.id||s.sessionId] || {};
    const node = document.createElement('div'); node.className='item';
    node.innerHTML = `<div><div class="title">${s.title||'Session'}</div>
      <div class="meta">${fmtDate(s.start)}${s.speaker?` ¬∑ ${s.speaker}`:''} ¬∑ Attendees: ${fmtNum(stats.attendees ?? s.attendees)} ¬∑ Rating: ${(stats.avgRating??s.avgRating??'‚Äì')}</div></div>
      <label class="badge"><input type="checkbox" data-sid="${s.id||s.sessionId}" /> Select</label>`;
    node.querySelector('input').addEventListener('change', (e)=>{
      const id = e.target.dataset.sid; if(e.target.checked) state.selectedSessionIds.add(id); else state.selectedSessionIds.delete(id);
    });
    sList.appendChild(node);
  }

  // Chart: sessions by day
  try {
    const byDay = aggregateByDay(ss);
    renderSessionsByDayChart(byDay);
  } catch(e){ console.warn('Chart error', e) }
}

function aggregateByDay(sessions){
  const map = new Map();
  for(const s of sessions){ const d = new Date(s.start||s.date); if(!isFinite(d)) continue; const key = d.toISOString().slice(0,10); map.set(key, (map.get(key)||0)+1); }
  const rows = Array.from(map.entries()).sort(([a],[b])=> a.localeCompare(b));
  return { labels: rows.map(r=> r[0]), values: rows.map(r=> r[1]) };
}

function renderSessionsByDayChart(data){
  const ctx = document.getElementById('chartSessionsByDay');
  if(state.charts.sessionsByDay){ state.charts.sessionsByDay.destroy(); }
  if(!data.labels.length){ ctx.replaceWith(ctx.cloneNode()); return }
  state.charts.sessionsByDay = new Chart(ctx, {
    type: 'line',
    data: { labels: data.labels, datasets: [{ label: 'Sessions', data: data.values, tension: .3, fill: false }] },
    options: { plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#8a93a6' } }, y: { ticks: { color: '#8a93a6' } } } }
  });
}

// --- Reports ---
async function generateEOD(){
  const id = state.selectedId; if(!id) return toast('Select a conference first');
  const date = ($('#eodDate').value || undefined);
  try {
    const res = await callFlow('reportEOD', { conferenceId: id, date });
    await handleReportResponse(res, `EOD-${id}-${date||Date.now()}`);
  } catch(e){ logError('EOD failed', { message: e.message }); toast(`<strong>Report failed:</strong> ${e.message}`) }
}
async function generateEOC(){
  const id = state.selectedId; if(!id) return toast('Select a conference first');
  try {
    const res = await callFlow('reportEOC', { conferenceId: id });
    await handleReportResponse(res, `EOC-${id}`);
  } catch(e){ logError('EOC failed', { message: e.message }); toast(`<strong>Report failed:</strong> ${e.message}`) }
}
async function generateVendorReport(){
  const id = state.selectedId; if(!id) return toast('Select a conference first');
  const vendorIds = Array.from(state.selectedVendorIds);
  if(!vendorIds.length) return toast('Select at least one vendor');
  try {
    const res = await callFlow('reportVendor', { conferenceId: id, vendorIds });
    await handleReportResponse(res, `Vendors-${id}`);
  } catch(e){ logError('Vendor report failed', { message: e.message }); toast(`<strong>Report failed:</strong> ${e.message}`) }
}
async function generateSessionReport(){
  const id = state.selectedId; if(!id) return toast('Select a conference first');
  const sessionIds = Array.from(state.selectedSessionIds);
  if(!sessionIds.length) return toast('Select at least one session');
  try {
    const res = await callFlow('reportSession', { conferenceId: id, sessionIds });
    await handleReportResponse(res, `Sessions-${id}`);
  } catch(e){ logError('Session report failed', { message: e.message }); toast(`<strong>Report failed:</strong> ${e.message}`) }
}

async function handleReportResponse(res, fallbackName){
  // 1) JSON shape with fileUrl
  if(res?.fileUrl){ window.open(res.fileUrl, '_blank'); toast('Download started'); logSuccess('Report opened via URL', { url: res.fileUrl }); return }
  // 2) JSON with base64 content
  if(res?.fileBase64){ const blob = base64ToBlob(res.fileBase64, res?.contentType||'application/octet-stream'); triggerDownloadFromBlob(blob, res?.fileName || (fallbackName+guessExt(res?.contentType))); toast('Downloaded'); logSuccess('Report downloaded (base64)'); return }
  // 3) Direct blob response
  if(res?.__blob){ triggerDownloadFromBlob(res.__blob, res.__filename || (fallbackName+guessExt(res?.contentType))); toast('Downloaded'); logSuccess('Report downloaded (blob)'); return }
  toast('Report generated ‚Äî check your inbox or storage target'); logInfo('Report generated without direct download');
}
function guessExt(ct){ if(!ct) return ''; const map={ 'application/pdf': '.pdf','text/csv':'.csv','application/zip':'.zip' }; return map[ct]||'' }
function base64ToBlob(b64, type){ const bin = atob(b64); const len = bin.length; const arr = new Uint8Array(len); for(let i=0;i<len;i++) arr[i] = bin.charCodeAt(i); return new Blob([arr], { type }) }

// --- Boot ---
async function refreshAll(){ logInfo('Loading conferences'); await loadConferences(); }
(function init(){ refreshAll(); })();
</script>
</body>
            </html>
