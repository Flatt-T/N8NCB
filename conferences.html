<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>conferenceBuddy ¬∑ Conferences</title>
  <meta name="description" content="Create, view, and report on conferences using n8n Flow Endpoints (strict spec)" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root { --bg:#0b0d12; --card:#121623; --muted:#8a93a6; --text:#e7ecf7; --primary:#7c5cff; --primary-600:#6847ff; --ring:#2a2f3d; --border:#1c2130; --shadow:0 8px 24px rgba(0,0,0,.35); --radius:16px; }
    * { box-sizing: border-box }
    html, body { height: 100% }
    body {
      margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 800px at 100% -20%, rgba(124,92,255,0.18), transparent),
                  radial-gradient(1000px 600px at -10% 0%, rgba(76,201,240,0.12), transparent),
                  var(--bg);
      color: var(--text);
    }
    a { color: #4cc9f0; text-decoration: none }
    header { position: sticky; top: 0; z-index: 5; backdrop-filter: saturate(1.2) blur(6px); background: linear-gradient(to bottom, rgba(11,13,18,0.9), rgba(11,13,18,0.6)); border-bottom: 1px solid var(--border) }
    .nav { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 16px; max-width:1200px; margin:0 auto }
    .brand { display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.3px }
    .brand .logo { width:28px; height:28px; border-radius:8px; background: linear-gradient(135deg, var(--primary), #4cc9f0); box-shadow: var(--shadow) }
    .nav-actions { display:flex; align-items:center; gap:8px }
    .btn, button { appearance:none; border:1px solid var(--ring); background:#0f1320; color:var(--text); padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer; transition:.2s }
    .btn:hover { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(124,92,255,.12) }
    .btn.primary { background: linear-gradient(180deg, var(--primary), var(--primary-600)); border:none }
    main { max-width:1200px; margin:16px auto; padding:0 16px }
    .grid { display:grid; grid-template-columns: 1fr; gap:16px }
    @media (min-width: 980px){ .grid { grid-template-columns: 360px 1fr } }
    .card { background: linear-gradient(180deg, rgba(18,22,35,.98), rgba(18,22,35,.9)); border:1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow) }
    .section { padding:16px }
    .divider { height:1px; background: var(--border); margin:12px 0 }
    .field { display:grid; gap:6px; margin-bottom:12px }
    label { font-size:13px; color: var(--muted) }
    input, textarea { width:100%; background:#0b0f1a; color: var(--text); border:1px solid var(--ring); border-radius:12px; padding:10px 12px; outline:none; transition:.2s }
    input:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(124,92,255,.12) }
    textarea { min-height: 72px; resize: vertical }
    .list { display:flex; flex-direction:column; gap:8px }
    .item { border:1px solid var(--ring); background:#0c101b; border-radius:12px; padding:10px; display:grid; grid-template-columns:1fr auto; align-items:center; gap:8px; cursor:pointer }
    .item:hover { border-color: var(--primary) }
    .item .title { font-weight:600 }
    .item .meta { font-size:12px; color:var(--muted) }
    .item .badge { background:#141a2a; border:1px solid var(--ring); padding:2px 8px; border-radius:999px; font-size:12px; color:var(--muted) }
    .two { display:grid; gap:12px; grid-template-columns:1fr }
    @media (min-width:720px){ .two { grid-template-columns: 1fr 1fr } }
    .tabs { display:flex; gap:6px; flex-wrap:wrap }
    .tab { border:1px solid var(--ring); padding:8px 12px; border-radius:10px; cursor:pointer; color:var(--muted) }
    .tab.active { color: var(--text); border-color: var(--primary) }
    .empty { text-align:center; color:var(--muted); padding:24px }
    #toasts { position:fixed; right:16px; bottom:16px; display:grid; gap:10px; z-index:50 }
    .toast { background:#0c101b; border:1px solid var(--ring); border-left:4px solid var(--primary); border-radius:12px; padding:12px 14px; box-shadow: var(--shadow) }
    /* Debug */
    .debug-toggle { position:fixed; right:16px; bottom:16px; z-index:85 }
    .debug-drawer { position:fixed; left:12px; right:12px; bottom:12px; z-index:90; display:none }
    .debug-drawer[open]{ display:block }
    .debug-card { background: var(--card); border:1px solid var(--border); border-radius:12px; box-shadow: var(--shadow); padding:10px }
    .debug-head { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px }
    .debug-body { background:#0b0f1a; border:1px solid var(--ring); border-radius:10px; padding:8px; max-height:32vh; overflow:auto; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; line-height:1.45 }
    .logline { display:grid; grid-template-columns:120px 80px 1fr; gap:8px; padding:4px 6px; border-bottom:1px dashed #1c2130 }
    .logline:last-child { border-bottom: 0 }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace }
  </style>
</head>
<body>
<header>
  <div class="nav">
    <div class="brand"><span class="logo"></span> conferenceBuddy</div>
    <div class="nav-actions">
      <button class="btn" id="refreshBtn" title="Refresh data">‚ü≥</button>
      <a class="btn" href="index.html">Home</a>
      <a class="btn primary" href="#create">+ New</a>
    </div>
  </div>
</header>

<main class="grid">
  <!-- Left: create + list -->
  <section class="card" id="create">
    <div class="section">
      <h3>Create conference</h3>
      <p class="muted">Strict-spec: POST /conference with api_version/request_id. ‚ÄúAims‚Äù maps to <code>goals_text</code>. ID is client-generated.</p>
      <form id="createForm" class="stack" autocomplete="off">
        <div class="field"><label for="cName">Name</label><input id="cName" name="name" required placeholder="DevSummit Europe 2026" /></div>
        <div class="two">
          <div class="field"><label for="cStart">Start date</label><input id="cStart" name="start_date" type="date" required /></div>
          <div class="field"><label for="cEnd">End date</label><input id="cEnd" name="end_date" type="date" required /></div>
        </div>
        <div class="two">
          <div class="field"><label for="cLocation">Location</label><input id="cLocation" name="location" placeholder="City, Country" /></div>
          <div class="field"><label for="cWebsite">Website URL</label><input id="cWebsite" name="website_url" placeholder="https://example.com" /></div>
        </div>
        <div class="field"><label for="cDesc">Description (client only)</label><textarea id="cDesc" name="description" placeholder="Short local-only note (not on API)"></textarea></div>
        <div class="field"><label for="cAims">Aims of the conference</label><textarea id="cAims" name="goals_text" placeholder="Goals / desired outcomes"></textarea></div>
        <div class="row">
          <button class="btn primary" type="submit">Create</button>
          <button class="btn" type="reset">Reset</button>
          <span class="muted">Settings live on the homepage.</span>
        </div>
      </form>
    </div>
    <div class="divider"></div>
    <div class="section">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <h3 style="margin:0">Conferences</h3>
        <input id="search" placeholder="Search name/location‚Ä¶" style="max-width:260px; background:#0b0f1a; color:#e7ecf7; border:1px solid var(--ring); border-radius:10px; padding:8px 10px" />
      </div>
      <div class="list" id="confList" aria-live="polite"></div>
    </div>
  </section>

  <!-- Right: details -->
  <section class="card" id="details">
    <div class="section">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <h3 style="margin:0">Details</h3>
        <span id="selectedMeta" class="item badge" style="border-radius:999px; padding:4px 8px; border:1px solid var(--ring); font-size:12px; color:#8a93a6">No conference selected</span>
      </div>

      <div id="emptyState" class="empty">Select a conference from the list.</div>
      <div id="detailWrap" style="display:none; display:grid; gap:12px;">
        <div class="row" style="justify-content: space-between;">
          <div>
            <div id="confTitle" style="font-weight:700; font-size:20px;"></div>
            <div id="confMeta" class="muted" style="margin-top:4px"></div>
            <div id="confAims" class="muted" style="margin-top:6px"></div>
          </div>
          <div class="row">
            <button id="eodBtn" class="btn">End-of-Day Report</button>
            <button id="eocBtn" class="btn">End-of-Conference Report</button>
          </div>
        </div>

        <div class="tabs" role="tablist">
          <button class="tab active" data-tab="overview" role="tab" aria-selected="true">Overview</button>
          <button class="tab" data-tab="vendors" role="tab">Vendors</button>
          <button class="tab" data-tab="sessions" role="tab">Sessions</button>
          <button class="tab" data-tab="reports" role="tab">Reports</button>
        </div>

        <div id="tab-overview" role="tabpanel" class="section" style="padding-top:0">
          <div class="two">
            <div class="card section">
              <strong>Key metrics</strong>
              <div class="two" style="margin-top:8px">
                <div class="item" style="cursor:default"><div><div class="title">Vendors (companies)</div><div class="meta"><span id="mVendors">‚Äì</span></div></div></div>
                <div class="item" style="cursor:default"><div><div class="title">Sessions</div><div class="meta"><span id="mSessions">‚Äì</span></div></div></div>
              </div>
            </div>
            <div class="card section">
              <strong>Sessions by day</strong>
              <canvas id="chartSessionsByDay" height="160"></canvas>
            </div>
          </div>
        </div>

        <div id="tab-vendors" role="tabpanel" class="section" hidden>
          <div class="row" style="justify-content: space-between;">
            <strong>Vendors</strong>
          </div>
          <div class="list" id="vendorList"></div>
        </div>

        <div id="tab-sessions" role="tabpanel" class="section" hidden>
          <div class="row" style="justify-content: space-between;">
            <strong>Sessions</strong>
          </div>
          <div class="list" id="sessionList"></div>
        </div>

        <div id="tab-reports" role="tabpanel" class="section" hidden>
          <div class="two">
            <div class="card section">
              <div class="row" style="justify-content:space-between;"><strong>End of Day</strong><input type="date" id="eodDate" /></div>
              <button id="eodBtn2" class="btn">Generate EOD (PDF)</button>
              <div id="eodStatus" class="muted" style="margin-top:8px"></div>
            </div>
            <div class="card section">
              <strong>End of Conference</strong>
              <button id="eocBtn2" class="btn">Generate EOC (PDF)</button>
              <div id="eocStatus" class="muted" style="margin-top:8px"></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>
</main>

<div id="toasts"></div>

<!-- Debug Drawer -->
<button class="btn debug-toggle" id="debugToggle">üêû Debug</button>
<div class="debug-drawer" id="debugDrawer">
  <div class="debug-card">
    <div class="debug-head">
      <strong>Debug log</strong>
      <div class="row">
        <button class="btn" id="dbgPause">Pause</button>
        <button class="btn" id="dbgCopy">Copy</button>
        <button class="btn" id="dbgClear">Clear</button>
        <button class="btn" id="dbgClose">Close</button>
      </div>
    </div>
    <div id="debugBody" class="debug-body" aria-live="polite"></div>
  </div>
</div>

<script>
/* ==== SETTINGS (read-only here; edit on homepage) ==== */
const DEFAULT_ENDPOINTS = { conference:'/conference', company:'/company', session:'/session', report:'/report' };
function getSettings(){
  try {
    const s = JSON.parse(localStorage.getItem('cb.settings')) || {};
    return { baseUrl: s.baseUrl||'', useGet: !!s.useGet, authHeader: s.authHeader||'', authValue: s.authValue||'', mapping: s.mapping||{} };
  } catch { return { baseUrl:'', useGet:false, authHeader:'', authValue:'', mapping:{} } }
}

/* ==== UTILITIES ==== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function toast(msg){ const n=document.createElement('div'); n.className='toast'; n.innerHTML=msg; $('#toasts').appendChild(n); setTimeout(()=>n.remove(), 4000); }
function fmtDate(d){ if(!d) return '‚Äî'; const dt = new Date(d); return isFinite(dt) ? dt.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'2-digit'}) : d; }
function uuid(){ return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c=>{ const r=Math.random()*16|0, v=c==='x'?r:(r&0x3|0x8); return v.toString(16); }); }

const Debug = { paused:false, add(level,msg,data){ const b=$('#debugBody'); const line=document.createElement('div'); line.className='logline'; const ts=new Date().toLocaleTimeString([], {hour12:false}); line.innerHTML=`<span class="mono">${ts}</span><span class="mono">${level.toUpperCase()}</span><span>${escapeHtml(msg)}${data?` ‚Äî <span class="mono">${escapeHtml(JSON.stringify(data))}</span>`:''}</span>`; b.appendChild(line); if(!Debug.paused){ b.scrollTop = b.scrollHeight } } };
function logI(m,d){ Debug.add('info',m,d) } function logS(m,d){ Debug.add('success',m,d) } function logE(m,d){ Debug.add('error',m,d) }
function escapeHtml(s){ return s?.replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) }

/* ==== STRICT-SPEC FETCH HELPERS ==== */
function paths(){ const cfg=getSettings(); const map=cfg.mapping||{}; return {
  conference: map.conference || DEFAULT_ENDPOINTS.conference,
  company: map.company || DEFAULT_ENDPOINTS.company,
  session: map.session || DEFAULT_ENDPOINTS.session,
  report: map.report || DEFAULT_ENDPOINTS.report,
  baseUrl: cfg.baseUrl, authHeader: cfg.authHeader, authValue: cfg.authValue
};}

function buildHeaders(){ const h={'Accept':'application/json','Content-Type':'application/json'}; const cfg=getSettings(); if(cfg.authHeader && cfg.authValue){ h[cfg.authHeader]=cfg.authValue } return h; }

/* GET with query params only (no bodies) */
async function GET(path, params={}){
  const p = paths(); if(!p.baseUrl) throw new Error('Base URL not set');
  const url = p.baseUrl + path + (Object.keys(params).length? ('?'+new URLSearchParams(params)) : '');
  logI('GET ' + path, params);
  const res = await fetch(url, { headers: buildHeaders() });
  if(!res.ok){ const t=await res.text().catch(()=>'(no body)'); logE('HTTP '+res.status+' '+path, {body:t.slice(0,200)}); throw new Error('HTTP '+res.status) }
  const json = await res.json();
  logS('OK ' + path);
  return json;
}

/* POST/PUT must include api_version + request_id in body */
async function SEND(method, path, payload){
  const p = paths(); if(!p.baseUrl) throw new Error('Base URL not set');
  const body = { api_version: '1.0', request_id: uuid(), ...payload };
  logI(method+' '+path, body);
  const res = await fetch(p.baseUrl + path, { method, headers: buildHeaders(), body: JSON.stringify(body) });
  if(!res.ok){ const t=await res.text().catch(()=>'(no body)'); logE('HTTP '+res.status+' '+path, {body:t.slice(0,200)}); throw new Error('HTTP '+res.status) }
  const json = await res.json();
  logS('OK ' + path);
  return json;
}

/* ==== STATE ==== */
let state = { list: [], selectedId: null, vendors: [], sessions: [], chart: null };

/* ==== UI EVENTS ==== */
$('#debugToggle').addEventListener('click', ()=> $('#debugDrawer').toggleAttribute('open'));
$('#dbgClose').addEventListener('click', ()=> $('#debugDrawer').removeAttribute('open'));
$('#dbgClear').addEventListener('click', ()=> $('#debugBody').innerHTML='');
$('#dbgCopy').addEventListener('click', async ()=>{ const text = Array.from($('#debugBody').querySelectorAll('.logline')).map(n=>n.textContent).join('\n'); try{ await navigator.clipboard.writeText(text); toast('Copied'); }catch{} });
$('#dbgPause').addEventListener('click', (e)=>{ Debug.paused=!Debug.paused; e.target.textContent = Debug.paused? 'Resume':'Pause' });

$('#refreshBtn').addEventListener('click', refreshAll);
$('#search').addEventListener('input', renderList);

$$('.tab').forEach(btn => btn.addEventListener('click', ()=>{
  $$('.tab').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const name = btn.dataset.tab;
  ['overview','vendors','sessions','reports'].forEach(t => { $('#tab-'+t).hidden = (t!==name) });
}));

/* Create conference (POST /conference) */
$('#createForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const form = new FormData(e.target);
  const name = form.get('name')?.trim();
  const start_date = form.get('start_date');
  const end_date = form.get('end_date');
  const location = form.get('location')?.trim() || null;
  const website_url = form.get('website_url')?.trim() || null;
  const goals_text = form.get('goals_text') || form.get('goals_text') || $('#cAims').value || null;

  if(!name || !start_date || !end_date){ toast('<strong>Missing required fields</strong>'); return; }

  const id = slugId(name, start_date); // client-stable id
  try{
    const payload = {
      conference: { id, name, start_date, end_date, location, website_url, goals_text: goals_text || null }
    };
    const res = await SEND('POST', paths().conference, payload);
    toast('Conference created');
    e.target.reset();
    await loadConferences();
    selectConference(id);
  } catch(err){ toast('Create failed: ' + err.message); }
});

function slugId(name, startDate){
  const slug = name.toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_|_$/g,'').slice(0,40);
  return `conf_${startDate}_${slug||'new'}`;
}

/* ==== LOADERS ==== */
async function loadConferences(){
  const p = paths();
  // GET /conference (list). We support optional filters; here: limit 50.
  const res = await GET(p.conference, { limit: 50 });
  const items = Array.isArray(res?.conferences) ? res.conferences : [];
  state.list = items;
  renderList();
}

function renderList(){
  const q = ($('#search').value||'').toLowerCase();
  const listNode = $('#confList'); listNode.innerHTML = '';
  const items = (state.list||[])
    .filter(c => !q || (c.name||'').toLowerCase().includes(q) || (c.location||'').toLowerCase().includes(q))
    .sort((a,b)=> (new Date(b.date_range?.[0]||0)) - (new Date(a.date_range?.[0]||0)));
  if(!items.length){ listNode.innerHTML = '<div class="empty">No conferences found</div>'; return }
  for(const c of items){
    const el = document.createElement('div'); el.className = 'item';
    const dr = Array.isArray(c.date_range) ? `${fmtDate(c.date_range[0])} ‚Äì ${fmtDate(c.date_range[1])}` : '‚Äî';
    el.innerHTML = `<div><div class="title">${c.name}</div><div class="meta">${dr}${c.location?` ¬∑ ${c.location}`:''}</div></div><div class="badge">${c.exhibitors_count ?? 0} vendors</div>`;
    el.addEventListener('click', ()=> selectConference(c.id));
    listNode.appendChild(el);
  }
}

async function selectConference(id){
  state.selectedId = id;
  $('#emptyState').style.display = 'none';
  $('#detailWrap').style.display = 'grid';
  $('#vendorList').innerHTML = '<div class="empty">Loading vendors‚Ä¶</div>';
  $('#sessionList').innerHTML = '<div class="empty">Loading sessions‚Ä¶</div>';

  try{
    const p = paths();
    const confRes = await GET(p.conference, { id });
    const c = confRes?.conference || {};
    $('#confTitle').textContent = c.name || id;
    const dr = Array.isArray(c.date_range) ? `${fmtDate(c.date_range[0])} ‚Äì ${fmtDate(c.date_range[1])}` : '';
    $('#confMeta').textContent = [dr, c.location].filter(Boolean).join(' ¬∑ ');
    $('#confAims').textContent = c.goals_text ? `Aims: ${c.goals_text}` : '';

    $('#selectedMeta').textContent = c.id || id;

    // Parallel: vendors & sessions
    const [vRes, sRes] = await Promise.all([
      GET(p.company, { conference_id: id, limit: 200 }),
      GET(p.session, { conference_id: id, limit: 200 })
    ]);

    const vendors = Array.isArray(vRes?.companies) ? vRes.companies : [];
    const sessions = Array.isArray(sRes?.sessions) ? sRes.sessions : [];
    state.vendors = vendors; state.sessions = sessions;

    $('#mVendors').textContent = vendors.length;
    $('#mSessions').textContent = sessions.length;

    renderVendors(vendors);
    renderSessions(sessions);
    renderSessionsByDayChart(sessions);

  } catch(err){ toast('Load failed: ' + err.message); }
}

function renderVendors(vendors){
  const list = $('#vendorList'); list.innerHTML = '';
  if(!vendors.length){ list.innerHTML = '<div class="empty">No vendors</div>'; return; }
  for(const v of vendors){
    const el = document.createElement('div'); el.className='item';
    el.innerHTML = `<div><div class="title">${v.name}</div><div class="meta">${v.booth?('Booth '+v.booth+' ¬∑ '):''}${(v.tags||[]).join(', ')}</div></div><div class="badge">${v.sentiment!=null?('SNT '+v.sentiment.toFixed(2)):'‚Äî'}</div>`;
    list.appendChild(el);
  }
}

function renderSessions(sessions){
  const list = $('#sessionList'); list.innerHTML = '';
  if(!sessions.length){ list.innerHTML = '<div class="empty">No sessions</div>'; return; }
  for(const s of sessions){
    const el = document.createElement('div'); el.className='item';
    el.innerHTML = `<div><div class="title">${s.summary||('Session '+s.id)}</div><div class="meta">${fmtDate(s.started_at)}${s.company_id?(' ¬∑ company '+s.company_id):''}${s.state?(' ¬∑ '+s.state):''}</div></div>`;
    list.appendChild(el);
  }
}

/* Chart: Sessions/day */
function renderSessionsByDayChart(sessions){
  const ctx = document.getElementById('chartSessionsByDay');
  if(state.chart){ state.chart.destroy(); state.chart = null; }
  const map = new Map();
  for(const s of sessions||[]){ const d = (s.started_at||'').slice(0,10); if(d) map.set(d, (map.get(d)||0)+1); }
  const labels = Array.from(map.keys()).sort();
  const values = labels.map(d => map.get(d));
  state.chart = new Chart(ctx, { type:'line', data:{ labels, datasets:[{ label:'Sessions', data: values, tension:.3, fill:false }] }, options:{ plugins:{ legend:{ display:false } } } });
}

/* ==== REPORTS (strict spec) ==== */
/* POST /report then poll GET /report?job_id=... until ready, then fetch GET /report?id=...&format=pdf */
async function generateReport({ type, date }){
  const p = paths();
  const conference_id = state.selectedId;
  if(!conference_id){ toast('Select a conference first'); return; }
  const reportId = `${conference_id}_${type}_${date||'all'}`;
  const payload = { report: { id: reportId, conference_id, type, date: (type==='daily'? date : undefined), format: 'pdf', options: {} } };
  const post = await SEND('POST', p.report, payload);
  if(post?.status!=='accepted'){ toast('Unexpected response'); }
  const jobId = post?.job_id;
  if(!jobId){ toast('No job id returned'); return; }
  const statusNode = (type==='daily') ? $('#eodStatus') : $('#eocStatus');
  statusNode.textContent = 'Job queued‚Ä¶';

  // poll
  let tries = 0;
  while(tries < 20){
    await sleep(1500);
    const stat = await GET(p.report, { job_id: jobId });
    const st = stat?.report?.status;
    statusNode.textContent = 'Status: ' + st;
    if(st === 'ready'){
      const rep = await GET(p.report, { id: reportId, format: 'pdf' });
      // If the backend includes a direct download_url in this response, open it.
      const maybeUrl = rep?.report?.download_url;
      if(maybeUrl){ window.open(maybeUrl, '_blank'); toast('Download started'); }
      else {
        // Otherwise show artifact/data file ids so the user can fetch via your n8n file endpoint.
        const artifact = rep?.report?.artifact_file_id || '(no artifact_file_id)';
        const datafile = rep?.report?.data_file_id || '(no data_file_id)';
        statusNode.textContent = `Ready (artifact: ${artifact}, data: ${datafile})`;
        toast('Report ready');
      }
      return;
    }
    if(st === 'error'){ toast('Report error'); return; }
    tries++;
  }
  toast('Report still processing; try again later.');
}
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)) }

$('#eodBtn').addEventListener('click', ()=> { const d=$('#eodDate').value; if(!d) { toast('Pick a date'); return; } generateReport({ type:'daily', date:d }) });
$('#eodBtn2').addEventListener('click', ()=> { const d=$('#eodDate').value; if(!d) { toast('Pick a date'); return; } generateReport({ type:'daily', date:d }) });
$('#eocBtn').addEventListener('click', ()=> generateReport({ type:'conference' }));
$('#eocBtn2').addEventListener('click', ()=> generateReport({ type:'conference' }));

/* ==== BOOT ==== */
async function refreshAll(){ try{ await loadConferences(); } catch(e){ toast('Load error: '+e.message) } }
(function init(){ refreshAll(); })();
</script>
</body>
</html>
